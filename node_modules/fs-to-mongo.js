var entity = 'uploads';
var fs = require("fs");
var uploads = process.server.createStore(entity);

var getFiles = function(){
    fs.readdir(entity, function(err, files){
        if (err) throw err;
        for (var i = files.length - 1; i >= 0; i--) {
            getMetaData(entity+'/'+files[i]);
        }
    });
}

setInterval(getFiles, 3000);

var getMetaData = function(file){
    fs.stat(file, function (err, stats) {
        if (err) throw err;
        var data = {};
        data['title'] = file;
        data['size'] = stats.size;
        data['modified'] = stats.mtime.toLocaleDateString();
        data['created'] = stats.ctime.toLocaleDateString();
        data['existence'] = true;
        validation(data);
    });
}

var validation = function(data){
    uploads.find(data, function(err, success){
        if (err) throw err;
        if(success.length == 0){
            dropToMongo(data);
        }
    });
}

var dropToMongo = function(data){
    uploads.insert(data, function(err, resp){
        if (err) throw err;
        console.log(resp.title + ' successfully sent to db');
    });
}